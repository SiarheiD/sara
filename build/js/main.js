"use strict";Function.prototype.throttle=function(e){var n=this,t=null,r=e;return function(){var e=this,a=arguments,o=Date.now();(!t||o-t>=r)&&(t=o,n.apply(e,a))}};var trimm=function(e,n,t){return e<n?n:e>t?t:e},getTransFormScaleXValue=function(e){var n=e.css("transform");return"none"===n?1:Number(n.slice(7,-1).split(",")[0])},getTransformTranslateX=function(e){var n=e.css("transform");return"none"===n?0:Number(e.css("transform").slice(7,-1).split(",")[4])},transitionEnd="transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",trTimeFunction={single:"ease-in-out",doubleFace:"ease-in",doubleBackface:"ease-out"},trDuration=.3,i=0,magazineSelector="#magazine",pageSelector=".magazine-page",Model={actModel:{},pages:[],pageInPlay:!1,pagesCount:0,index:0,get currentIndex(){return this.index},set currentIndex(e){this.index=trimm(e,0,this.pagesCount-1),window.location.hash=this.index+1},animate:function(e,n){var t=this;t.animateFunction[n][e.dir](e,n)},newTurnEvent:function(e){var n=$.Event("turned");n.dir=e,$(window).trigger(n)},animateFunction:{single:{prev:function(e){View.changedPages=[];var n=View.pages.eq(Model.currentIndex-1),e=1-getTransFormScaleXValue(n);Model.currentIndex>0&&(n.css({transition:"transform "+trDuration*e+"s "+trTimeFunction.single,transform:"scaleX(1)"}),Model.pageInPlay=!0,n.on(transitionEnd,function(){$(this).removeClass("turned"),$(this).css({transform:"",transition:""}),Model.currentIndex-=1,Model.pageInPlay=!1,View.hideUnnecessaryPages(Model.currentIndex),$(this).off(transitionEnd)}))},next:function(){View.changedPages=[];var e=View.pages.eq(Model.currentIndex),n=getTransFormScaleXValue(e);Model.currentIndex<Model.pagesCount-1?(e.css({transition:"transform "+trDuration*n+"s "+trTimeFunction.single,transform:"scaleX(0)"}),Model.pageInPlay=!0,e.on(transitionEnd,function(){$(this).addClass("turned"),$(this).css({transform:"",transition:""}),Model.currentIndex+=1,Model.pageInPlay=!1,View.hideUnnecessaryPages(Model.currentIndex),$(this).off(transitionEnd)})):(View.changedPages=[],e.css({transition:"transform "+trDuration*n+"s "+trTimeFunction.single,transform:"scaleX(1)"}),Model.pageInPlay=!0,e.on(transitionEnd,function(){$(this).css({transform:"",transition:""}),Model.pageInPlay=!1}))}},double:{prev:function(){function e(e){var n=1-getTransFormScaleXValue(e);e.css({transition:"transform "+trDuration*n+"s "+trTimeFunction.doubleBackface,transform:"scaleX(1)"}),e.on(transitionEnd,function(){$(this).removeClass("turned"),$(this).css({transition:"",transform:""}),Model.currentIndex-=2,Model.pageInPlay=!1,View.hideUnnecessaryPages(Model.currentIndex),e.off(transitionEnd)})}function n(n,t){var r=getTransFormScaleXValue(n);n.css({transition:"transform "+trDuration*r+"s "+trTimeFunction.doubleFace,transform:"scaleX(0)"}),n.on(transitionEnd,function(){e(t),$(this).removeClass("turned"),$(this).css({transition:"",transform:""}),n.off(transitionEnd)})}function t(e){var n,t;0===e?(n=1-Math.abs(getTransformTranslateX(View.container)/$(window).width())/.25,t="-25%"):1===e&&(n=Math.abs(getTransformTranslateX(View.container)/$(window).width())/.25,t="0"),View.changedContainer=null,View.container.css({transition:"transform "+trDuration*n+"s",transform:"translateX("+t+")"}),View.container.on(transitionEnd,function(){$(this).css({transition:""}),View.container.off(transitionEnd)})}var r,a;return Model.currentIndex>0&&(Model.currentIndex%2===0?(r=View.pages.eq(Model.currentIndex-1),a=View.pages.eq(Model.currentIndex-2)):(r=View.pages.eq(Model.currentIndex),a=View.pages.eq(Model.currentIndex-1)),View.changedPages=[],Model.pageInPlay=!0,0===getTransFormScaleXValue(r)?e(a):n(r,a),void(1===Model.currentIndex||2===Model.currentIndex?t(0):Model.currentIndex===Model.pagesCount-1&&Model.pagesCount%2===0&&t(1)))},next:function(e,n){function t(e,n){var t=1-getTransFormScaleXValue(e);e.css({transition:"transform "+trDuration*t+"s "+trTimeFunction.doubleBackface,transform:"scaleX(1)"}),e.on(transitionEnd,function(){n||($(this).addClass("turned"),Model.currentIndex+=2),$(this).css({transition:"",transform:""}),Model.pageInPlay=!1,View.hideUnnecessaryPages(Model.currentIndex),e.off(transitionEnd)})}function r(e,n){var r=getTransFormScaleXValue(e);e.css({transition:"transform "+trDuration*r+"s "+trTimeFunction.doubleFace,transform:"scaleX(0)"}),e.on(transitionEnd,function(){t(n),$(this).addClass("turned"),$(this).css({transition:"",transform:""}),e.off(transitionEnd)})}function a(e){var n,t;0===e?(n=Math.abs(getTransformTranslateX(View.container)/$(window).width())/.25,t="0"):1===e&&(n=1-Math.abs(getTransformTranslateX(View.container)/$(window).width())/.25,t="25%"),View.changedContainer=null,View.container.css({transition:"transform "+trDuration*n+"s",transform:"translateX("+t+")"}),View.container.on(transitionEnd,function(){$(this).css({transition:""}),View.container.off(transitionEnd)})}var o,i;return(Model.currentIndex!==Model.pagesCount-1||Model.pagesCount%2!==0)&&(Model.currentIndex%2===0?(o=View.pages.eq(Model.currentIndex),i=View.pages.eq(Model.currentIndex+1)):(o=View.pages.eq(Model.currentIndex+1),i=View.pages.eq(Model.currentIndex+2)),0===Model.currentIndex?a(0):Model.currentIndex>Model.pagesCount-4&&Model.pagesCount%2===0&&a(1),View.changedPages=[],Model.pageInPlay=!0,void(Model.currentIndex>=Model.pagesCount-2&&Model.pagesCount%2!==0?t(o,"last"):0===getTransFormScaleXValue(o)?t(i):r(o,i)))}}},drawFunction:{single:{prev:function(e,n){var t,r,a=Model;t=n?n:trimm(e.x,0,1),r=a.currentIndex-1,r>=0&&(View.changedPages[r]=t)},next:function(e,n){var t,r=Model;t=n?n:trimm(1+e.x,0,1),View.changedPages[r.currentIndex]=t}},double:{prev:function(e,n){var t,r,a,o=Model;o.currentIndex%2===0?(t=o.currentIndex-1,r=o.currentIndex-2):(t=o.currentIndex,r=o.currentIndex-1),1===o.currentIndex||2===o.currentIndex?View.changedContainer=trimm(25*-e.x,-25,0):o.pagesCount%2===0&&o.currentIndex===o.pagesCount-1&&(View.changedContainer=trimm(25*(1-e.x),0,25)),e.x<=.5?(a=n?n:trimm(1-2*e.x,0,1),View.changedPages[r]=n||0,View.changedPages[t]=a):(a=n?n:trimm(2*e.x-1,0,1),View.changedPages[t]=n||0,View.changedPages[r]=a)},next:function(e,n){var t,r,a,o=Model;return(Model.currentIndex!==Model.pagesCount-1||Model.pagesCount%2!==0)&&(o.currentIndex%2===0?(t=o.currentIndex,r=o.currentIndex+1):(t=o.currentIndex+1,r=o.currentIndex+2),0===o.currentIndex?View.changedContainer=trimm(-25-25*e.x,-25,0):o.pagesCount%2===0&&o.currentIndex>=o.pagesCount-3&&(View.changedContainer=trimm(25*-e.x,0,25)),void(e.x>=-.5?(a=n?n:trimm(1+2*e.x,0,1),View.changedPages[t]=a,View.changedPages[r]=n||0):(a=n?n:trimm(2*-e.x-1,0,1),View.changedPages[t]=n||0,View.changedPages[r]=a)))}}},draw:function(e,n){var t=this;t.drawFunction[n][e.dir](e)},checkHash:function(){var e=this,n=Number(window.location.hash.slice(1));return isNaN(n)?e:n-1===e.currentIndex?e:(e.currentIndex=n-1,void View.goTo(e.currentIndex))},init:function(e,n){var t=this;View.init(e,n),t.count=View.pages.length}},View={magazine:null,pages:null,container:null,viewMode:"",changedPages:[],changedContainer:null,drawPage:function(e,n){var t=this;return"number"==typeof n?(t.pages.eq(e).css("transform","scaleX("+n+")"),t):"animationEnded"===n?(t.pages.eq(e).css("transform",""),t.pages.eq(e).toggleClass("turned"),t):("animationCanceled"===n&&t.pages.eq(e).css("transform",""),t)},drawContainer:function(){var e=this;return!!e.changedContainer&&(e.container.css("transform","translateX("+e.changedContainer+"%)"),e.changedContainer=null,e)},drawChangedPages:function(){for(var e=this,n=0,t=e.changedPages.length;n<t;n++)e.changedPages.hasOwnProperty(n)&&(e.drawPage(n,e.changedPages[n]),delete e.changedPages[n])},hideUnnecessaryPages:function(e){var n=this,t=n.pages;return t.removeClass("hidden"),"single"===n.viewMode?(t.eq(e-1<0?0:e-1).prevAll().addClass("hidden"),t.eq(e+1).nextAll().addClass("hidden")):"double"===n.viewMode&&(t.eq(e-3<0?0:e-3).prevAll().addClass("hidden"),t.eq(e+3).nextAll().addClass("hidden")),n},drawLoop:function(){var e=View;e.drawChangedPages(),e.drawContainer(),requestAnimationFrame(e.drawLoop)},checkViewMode:function(){var e=this;return $(window).width()/$(window).height()>=750/667?"double"!==e.viewMode&&(e.viewMode="double"):"single"!==e.viewMode&&(e.viewMode="single",e.hideUnnecessaryPages(Model.currentIndex)),e.goTo(Model.currentIndex),e},goTo:function(e){var n=this,t=n.pages;return Model.currentIndex=e,e=Model.currentIndex,"single"===n.viewMode||"double"===n.viewMode&&e%2===0?(t.eq(e).prevAll().addClass("turned"),t.eq(e).nextAll().removeClass("turned"),t.eq(e).removeClass("turned")):"double"===n.viewMode&&e%2!==0&&(t.eq(e).prevAll().addClass("turned"),t.eq(e).addClass("turned"),t.eq(e).nextAll().removeClass("turned")),"double"===n.viewMode?0===e?n.container.css("transform","translateX(-25%)"):e===n.pages.length-1&&e%2!==0?n.container.css("transform","translateX(25%)"):n.container.css("transform",""):n.container.css("transform",""),n.hideUnnecessaryPages(),n},zIndexRules:function(e){for(var n=this,t=n.pages.length,r=$('<style type="text/css">'),a="",o=1;o<=t;o++)a+=e+":nth-child("+o+"){z-index: "+(t+10-o)+";}\r\n";return r.text(a),$("head").append(r),n},init:function(e,n){var t=this;t.magazine=$(e),t.pages=t.magazine.find(n),Model.pagesCount=t.pages.length,t.container=t.magazine.children(".container"),Model.checkHash(),t.zIndexRules(n).checkViewMode().goTo(Model.currentIndex).hideUnnecessaryPages(Model.currentIndex).drawLoop(),Model.pagesCount=t.pages.length}},Controller={startMoving:function(e){},pageMove:function(e){Model.draw(e,View.viewMode)},stopMoving:function(e){Model.animate(e,View.viewMode)},resize:function(){View.checkViewMode().hideUnnecessaryPages(Model.currentIndex)},onTurn:function(e){var n="next"===e.dir?1:-1,t="single"===View.viewMode?1:2;Model.currentIndex+=n*t,View.hideUnnecessaryPages(Model.currentIndex)},hashChange:function(){Model.checkHash()}};!function(){var e={init:function(){this.event(),this.main()},main:function(){Model.init(magazineSelector,pageSelector)},event:function(){var e=!1;$(window).on("mousedown touchstart",function(n){if(e)return!1;if(Model.pageInPlay)return!1;e=!0,"touchstart"===n.type&&(n.originalEvent.changedTouches[0].preventDefault=n.preventDefault,n.originalEvent.changedTouches[0].stopPropagation=n.stopPropagation,n=n.originalEvent.changedTouches[0]),n.preventDefault();var t=!1,r={},a=$(window).width();$(window).on("mousemove touchmove",function(e){"touchmove"===e.type&&(e.originalEvent.changedTouches[0].preventDefault=e.preventDefault,e.originalEvent.changedTouches[0].stopPropagation=e.stopPropagation,e=e.originalEvent.changedTouches[0]),e.preventDefault(),r.x=(e.pageX-n.pageX)/a,t?Controller.pageMove(r):Math.abs(e.pageX-n.pageX)>5&&(t=!0,r.dir=r.x<0?"next":"prev",Controller.startMoving(r))}.throttle(12)),$(window).on("mouseup touchend",function(n){$(window).off("mousemove"),$(window).off("touchmove"),t&&Controller.stopMoving(r),e=!1,$(window).off("mouseup"),$(window).off("touchend")})}),$(window).on("resize",Controller.resize),$(window).on("hashchange",Controller.hashChange),$(window).on("turned",Controller.onTurn)}};e.init()}();